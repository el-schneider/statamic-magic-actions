function v(e){return new Promise(t=>setTimeout(t,e))}function m(e){if(!e)return"";if(typeof e=="string")return e;if(typeof e=="object"&&e!==null){const t=e;return t.type==="text"&&typeof t.text=="string"?t.text:Array.isArray(e)?e.map(m).filter(Boolean).join(`
`):Object.values(t).map(m).filter(Boolean).join(`
`)}return""}function A(e){return typeof e=="string"?e.includes("::"):Array.isArray(e)&&e.length>0&&typeof e[0]=="string"?e[0].includes("::"):!1}function h(e){const t=e.match(/browse\/([^/]+)\/(.+?)\/edit/);return t?`${t[1]}::${t[2]}`:null}function T(e,t,o,i){if(e.actionType==="audio")return"transcription";if(e.actionType==="vision"||h(i)!==null&&!t.magic_actions_source)return"vision";const r=o[t.magic_actions_source];return A(r)?"vision":"completion"}function w(e,t,o){const i=h(o);if(i)return i;const n=t[e.magic_actions_source];if(Array.isArray(n)&&n.length>0)return n[0];throw new Error("No asset selected")}function E(){const e=window.location.pathname,t=e.match(/\/cp\/collections\/([^/]+)\/entries\/([^/]+)/);if(t)return{type:"entry",id:t[2],field:""};const o=e.match(/\/cp\/assets\/browse\/(.+?)\/edit/);return o?{type:"asset",id:o[1],field:""}:null}const u={completion:"/!/statamic-magic-actions/completion",vision:"/!/statamic-magic-actions/vision",transcription:"/!/statamic-magic-actions/transcribe",status:"/!/statamic-magic-actions/status"};async function b(e,t=120,o=1e3){for(let i=0;i<t;i++){const n=await window.Statamic.$axios.get(`${u.status}/${e}`),{status:r,data:a,error:c}=n.data;if(r==="completed")return{data:a??""};if(r==="failed")throw new Error(c||"Job failed");await v(o)}throw new Error("Timed out waiting for job to complete")}async function k(e,t,o){const i={text:e,action:t};o&&(i.context_type=o.type,i.context_id=o.id,i.field_handle=o.field);const n=await window.Statamic.$axios.post(u.completion,i);if(!n.data.job_id)throw new Error("No job ID returned from the server");return{jobId:n.data.job_id}}async function P(e,t,o={},i){const n={asset_path:e,action:t,variables:o};i&&(n.context_type=i.type,n.context_id=i.id,n.field_handle=i.field);const r=await window.Statamic.$axios.post(u.vision,n);if(!r.data.job_id)throw new Error("No job ID returned from the server");return{jobId:r.data.job_id}}async function F(e,t,o){const i={asset_path:e,action:t};o&&(i.context_type=o.type,i.context_id=o.id,i.field_handle=o.field);const n=await window.Statamic.$axios.post(u.transcription,i);if(!n.data.job_id)throw new Error("No job ID returned from the server");return{jobId:n.data.job_id}}const J=`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" /></svg>
`,x="magic_actions_jobs_",l=new Map;function _(e){return`${x}${e.type}_${e.id.replace(/[/:]/g,"_")}`}function p(e){try{const t=_(e),o=localStorage.getItem(t);return o?JSON.parse(o):[]}catch{return[]}}function $(e,t){const o=_(e);t.length===0?localStorage.removeItem(o):localStorage.setItem(o,JSON.stringify(t))}function j(e,t){const o=p(e).filter(i=>i.jobId!==t);$(e,o)}function L(e,t){const o=l.get(e);o&&(o(t),l.delete(e))}function N(e,t,o,i,n){const r=p(e),a={jobId:t,fieldHandle:o,fieldTitle:i};r.some(c=>c.jobId===t)||(r.push(a),$(e,r)),l.set(t,n),C(e,a)}async function C(e,t){try{const o=await b(t.jobId);L(t.jobId,o.data),window.Statamic.$toast.success(`"${t.fieldTitle}" completed!`)}catch(o){const i=o instanceof Error?o.message:"Unknown error";window.Statamic.$toast.error(`"${t.fieldTitle}" failed: ${i}`),l.delete(t.jobId)}finally{j(e,t.jobId)}}async function M(e){const t=p(e);if(t.length!==0)for(const o of t)window.Statamic.$toast.info(`"${o.fieldTitle}" is still processing...`),O(e,o)}async function O(e,t){try{await b(t.jobId),window.Statamic.$toast.info(`"${t.fieldTitle}" completed. Please save and refresh to see the result.`)}catch(o){const i=o instanceof Error?o.message:"Unknown error";window.Statamic.$toast.error(`"${t.fieldTitle}" failed: ${i}`)}finally{j(e,t.jobId)}}async function B(e,t,o,i,n,r){if(e==="vision"){const s=w(o,i,n);return(await P(s,t,{},r)).jobId}if(e==="transcription"){const s=w(o,i,n);return(await F(s,t,r)).jobId}const a=m(i[o.magic_actions_source]);if(!a)throw new Error("Source field is empty");return(await k(a,t,r)).jobId}function D(e){const t=e.magic_actions_action;return typeof t=="string"?t?[t]:[]:Array.isArray(t)?t.filter(o=>typeof o=="string"):[]}function g(e,t,o){return{title:t.title,quick:!0,visible:({config:i,handle:n})=>!i?.magic_actions_enabled||n!==e.fieldHandle?!1:D(i).includes(t.actionHandle),icon:t.icon??J,run:async({handle:i,update:n,store:r,storeName:a,config:c})=>{try{const s=r.state.publish[a].values,d=window.location.pathname,S=T(t,c,s,d),f=o?{...o,field:i}:void 0;if(!f)throw new Error("Could not determine page context");const I=await B(S,t.actionHandle,c,s,d,f);window.Statamic.$toast.info(`"${t.title}" started...`),N(f,I,i,t.title,n)}catch(s){const d=s instanceof Error?s.message:"Failed to start the action";window.Statamic.$toast.error(d)}}}}function y(){const e=window.StatamicConfig?.magicFields;if(!e?.length)return;const t=E();for(const o of e){const i=`${o.component}-fieldtype`;if(o.actions.length===1){window.Statamic.$fieldActions.add(i,g(o,o.actions[0],t));continue}for(const n of o.actions)window.Statamic.$fieldActions.add(i,g(o,n,t))}t&&M(t)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",y):y();
