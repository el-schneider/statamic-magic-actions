const A={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",mp3:"audio/mpeg",mp4:"audio/mp4",wav:"audio/wav",webm:"audio/webm",ogg:"audio/ogg",flac:"audio/flac",pdf:"application/pdf"};function S(e){return new Promise(t=>setTimeout(t,e))}function f(e){if(!e)return"";if(typeof e=="string")return e;if(typeof e=="object"&&e!==null){const t=e;return t.type==="text"&&typeof t.text=="string"?t.text:Array.isArray(e)?e.map(f).filter(Boolean).join(`
`):Object.values(t).map(f).filter(Boolean).join(`
`)}return""}function E(e){if(typeof e=="string")return e.includes("::");if(Array.isArray(e)){const t=e.find(o=>typeof o=="string");return typeof t=="string"&&t.includes("::")}return!1}function b(e){const t=e.match(/browse\/([^/]+)\/(.+?)\/edit/);return t?`${t[1]}::${t[2]}`:null}function x(e,t,o,n){if(e.actionType==="audio")return"transcription";if(e.actionType==="vision"||b(n)!==null&&!t.magic_actions_source)return"vision";const r=t.magic_actions_source?o[t.magic_actions_source]:void 0;return E(r)?"vision":"completion"}function k(e,t,o){const n=b(o);if(n)return n;const i=e.magic_actions_source?t[e.magic_actions_source]:void 0;if(Array.isArray(i)&&i.length>0)return i[0];throw new Error("No asset selected")}function _(){const e=window.location.pathname,t=e.match(/\/cp\/collections\/([^/]+)\/entries\/([^/]+)/);if(t)return{type:"entry",id:t[2],field:""};const o=e.match(/\/cp\/assets\/browse\/(.+?)\/edit/);return o?{type:"asset",id:o[1],field:""}:null}function C(){const e=window.location.pathname.match(/\/cp\/assets\/browse\/[^/]+\/(.+?)\/edit$/);if(!e)return null;const t=decodeURIComponent(e[1]),o=t.split("/").pop()??t,n=o.lastIndexOf(".");return n<=0||n===o.length-1?null:o.substring(n+1).toLowerCase()}function F(e,t){if(e.length===0||!t)return!0;const o=A[t];if(!o)return!0;const n=o.toLowerCase();return e.some(i=>{const r=i.toLowerCase();return r==="*/*"?!0:r.endsWith("/*")?n.startsWith(r.slice(0,-1)):r===n})}const d={completion:"/!/statamic-magic-actions/completion",vision:"/!/statamic-magic-actions/vision",transcription:"/!/statamic-magic-actions/transcribe",status:"/!/statamic-magic-actions/status"};function p(e,t){return t?{...e,context_type:t.type,context_id:t.id,field_handle:t.field}:e}function m(e){if(!e.job_id)throw new Error("No job ID returned from the server");return e.job_id}async function $(e,t=120,o=1e3){for(let n=0;n<t;n++){const i=await window.Statamic.$axios.get(`${d.status}/${e}`),{status:r,data:a,error:s}=i.data;if(r==="completed")return{data:a??""};if(r==="failed")throw new Error(s||"Job failed");await S(o)}throw new Error("Timed out waiting for job to complete")}async function J(e,t,o){const n=p({text:e,action:t},o),i=await window.Statamic.$axios.post(d.completion,n);return{jobId:m(i.data)}}async function L(e,t,o={},n){const i=p({asset_path:e,action:t,variables:o},n),r=await window.Statamic.$axios.post(d.vision,i);return{jobId:m(r.data)}}async function M(e,t,o){const n=p({asset_path:e,action:t},o),i=await window.Statamic.$axios.post(d.transcription,n);return{jobId:m(i.data)}}const P=`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" /></svg>
`,N="magic_actions_jobs_",l=new Map;function O(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.jobId=="string"&&typeof t.fieldHandle=="string"&&typeof t.fieldTitle=="string"}function T(e){return`${N}${e.type}_${e.id.replace(/[/:]/g,"_")}`}function g(e){try{const t=T(e),o=localStorage.getItem(t),n=o?JSON.parse(o):[];return Array.isArray(n)?n.filter(O):[]}catch{return[]}}function j(e,t){const o=T(e);t.length===0?localStorage.removeItem(o):localStorage.setItem(o,JSON.stringify(t))}function I(e,t){const o=g(e).filter(n=>n.jobId!==t);j(e,o)}function U(e,t){const o=l.get(e);o&&(o(t),l.delete(e))}function B(e,t,o,n,i){const r=g(e),a={jobId:t,fieldHandle:o,fieldTitle:n};r.some(s=>s.jobId===t)||(r.push(a),j(e,r)),l.set(t,i),H(e,a)}async function H(e,t){try{const o=await $(t.jobId);U(t.jobId,o.data),window.Statamic.$toast.success(`"${t.fieldTitle}" completed!`)}catch(o){const n=o instanceof Error?o.message:"Unknown error";window.Statamic.$toast.error(`"${t.fieldTitle}" failed: ${n}`),l.delete(t.jobId)}finally{I(e,t.jobId)}}async function R(e){const t=g(e);if(t.length!==0)for(const o of t)window.Statamic.$toast.info(`"${o.fieldTitle}" is still processing...`),V(e,o)}async function V(e,t){try{await $(t.jobId),window.Statamic.$toast.info(`"${t.fieldTitle}" completed. Please save and refresh to see the result.`)}catch(o){const n=o instanceof Error?o.message:"Unknown error";window.Statamic.$toast.error(`"${t.fieldTitle}" failed: ${n}`)}finally{I(e,t.jobId)}}async function D(e,t,o,n,i,r){if(e==="completion"){const c=f(n[o.magic_actions_source]);if(!c)throw new Error("Source field is empty");return(await J(c,t,r)).jobId}const a=k(o,n,i);return e==="vision"?(await L(a,t,{},r)).jobId:(await M(a,t,r)).jobId}function Z(e){const t=e.magic_actions_action;return typeof t=="string"?t?[t]:[]:Array.isArray(t)?t.filter(o=>typeof o=="string"):[]}function z(e,t){return{title:t.title,quick:!0,visible:({config:o,handle:n})=>!o?.magic_actions_enabled||n!==e.fieldHandle||!Z(o).includes(t.actionHandle)?!1:F(t.acceptedMimeTypes,C()),icon:t.icon??P,run:async({handle:o,update:n,store:i,storeName:r,config:a})=>{try{const s=i.state.publish[r].values,c=window.location.pathname,w=x(t,a,s,c),y=_(),u=y?{...y,field:o}:void 0;if(!u)throw new Error("Could not determine page context");const v=await D(w,t.actionHandle,a,s,c,u);window.Statamic.$toast.info(`"${t.title}" started...`),B(u,v,o,t.title,n)}catch(s){const c=s instanceof Error?s.message:"Failed to start the action";window.Statamic.$toast.error(c)}}}}function h(){const e=window.StatamicConfig?.magicFields;if(!e?.length)return;for(const o of e){const n=`${o.component}-fieldtype`;for(const i of o.actions)window.Statamic.$fieldActions.add(n,z(o,i))}const t=_();t&&R(t)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",h):h();
